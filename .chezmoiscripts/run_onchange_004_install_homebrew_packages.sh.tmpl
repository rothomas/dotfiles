{{- define "brew_install" }}
{{ if .use_system }}if ! command -v {{ .package }} > /dev/null; then{{ end }}
if ! brew list -q {{ .package }} >& /dev/null
  brew install {{if .cask}}--cask {{end}}{{ .package }}
fi
{{ if .service }}brew services start {{ .package }}{{ end }}
{{ if .use_system }}fi{{ end }}
{{ end -}}

{{ if not (eq .chezmoi.username "root") -}}
#!/usr/bin/env bash

>&2 echo "Installing Homebrew Packages"

eval "$({{ .brew }} shellenv)"

{{ range .brew.common }}
{{ template "brew_install" . }}
{{ end }}

{{ range (get .brew .chezmoi.os) }}
{{ template "brew_install" . }}
{{ end }}

{{- end }}
