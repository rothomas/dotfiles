#!/usr/bin/env bash

if [[ "${ITERM_PROFILE}" == "no-tmux" ]]; then
  exit 0
fi

HOSTNAME="$(hostname -s)"
TMUX="$(sed 's/tmux is //' <<< $(type -p tmux))"
if [[ -z "${SESSION_ID}" ]]; then
  export TMUX_SESSION="${HOSTNAME}"
else
  export TMUX_SESSION="${SESSION_ID}"
fi

# Uncomment to use iTerm2's tmux control mode.
#if [[ ! -z "${TERM_SESSION_ID}" ]]; then
#  TMUX_FLAGS='-CC'
#fi

>&2 printf "tmux session: ${TMUX_SESSION}"
if tmux has -t "${TMUX_SESSION}" &> /dev/null; then
  >&2 echo " (attaching)"
  command="exec env TMUX_SESSION=\"${TMUX_SESSION}\" tmux ${TMUX_FLAGS} attach -t \"${TMUX_SESSION}\""
else
  >&2 echo " (creating)"
  command="exec env TMUX_SESSION=\"${TMUX_SESSION}\" tmux ${TMUX_FLAGS} new -s \"${TMUX_SESSION}\""
fi
>&2 echo "${command}"
echo "${command}"

