{{- $date := "date" -}}
{{- if eq $.chezmoi.os "darwin" -}}
{{-   $date = "/usr/local/bin/gdate" -}}
{{- end -}}
export XDG_CONFIG_HOME="${HOME}/.config"
export ZSH_BUNDLES="${XDG_CONFIG_HOME}/zsh/bundles"

alias is_debug="[[ -n $ZSH_DEBUG ]]"
alias is_interactive="[[ -o interactive ]]"
alias is_login="[[ -o login ]]"
alias is_batch="! is_interactive && ! is_login"
alias timestamp="{{ $date }} +'%s%N'"

is_debug && dotfile_start="$(timestamp)"

eval "$({{ $.brew_install_location }}/bin/brew shellenv)"

function duration_since() {
  local start="${1}" end="$(timestamp)"
  delta="$(bc <<< "scale=3; ($end-$start)/1000000000")"
  printf "%.3fs" "$delta"
}

export TZ="America/Denver"
export COLORTERM=truecolor
function zsh_bundles() {
  for script in "${(@f)"$(find "${ZSH_BUNDLES}" -name "${1}" | sort)"}"
  {
    if is_debug; then
      echo "printf \"Including ${script}\""
      echo "fragment_start=\"$(timestamp)\""
    fi
    echo "source \"${script}\""
    if is_debug; then
      echo "echo \"$(duration_since \"$fragment_start\")\""
    fi
  }
}

DOTFILE="zshenv" source "${XDG_CONFIG_HOME}/zsh/.zpath"

eval "$(zsh_bundles zshenv)"
is_debug && echo "Total zshenv: $(duration_since $dotfile_start)" || true

is_batch && source "${XDG_CONFIG_HOME}/zsh/.zcleanup"

